# Copy this file into your BUILD_REPO as: .github/workflows/build.yml
#
# Requirements:
# - BUILD_REPO is public and contains workflows only.
# - SOURCE_REPO is private and contains code + tool/ci/build.* scripts.
# - BUILD_REPO Actions secret: SOURCE_REPO_SSH_KEY (read-only deploy key for SOURCE_REPO).
#
# This workflow is workflow_dispatch-only and uploads short-lived artifacts.

name: build

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: "owner/SOURCE_REPO (private)"
        required: true
        type: string
      source_ref:
        description: "Git ref in SOURCE_REPO (branch/tag/sha)"
        required: true
        type: string
      artifact_name:
        description: "Artifact name prefix"
        required: false
        default: "okret-chat"
        type: string
      platforms:
        description: "Comma-separated: windows,linux,android,server"
        required: false
        default: "windows,linux,android,server"
        type: string

permissions:
  contents: read

jobs:
  windows:
    if: contains(inputs.platforms, 'windows')
    runs-on: windows-latest
    steps:
      - name: Setup SSH (deploy key)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}

      - name: Clone private source
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          git clone "git@github.com:${{ inputs.source_repo }}.git" source
          cd source
          git checkout "${{ inputs.source_ref }}"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.29.3
          cache: true

      - name: Build (Windows app + server)
        shell: pwsh
        run: |
          ./source/tool/ci/build.ps1 -Target windows -OutDir "$env:GITHUB_WORKSPACE\\artifacts" -Project apps/okret_chat
          ./source/tool/ci/build.ps1 -Target windows -OutDir "$env:GITHUB_WORKSPACE\\artifacts" -Project apps/okret_admin
          ./source/tool/ci/build.ps1 -Target server -OutDir "$env:GITHUB_WORKSPACE\\artifacts"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-windows
          path: artifacts/*
          retention-days: 1
          if-no-files-found: error

  linux:
    if: contains(inputs.platforms, 'linux')
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH (deploy key)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}

      - name: Clone private source
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          git clone "git@github.com:${{ inputs.source_repo }}.git" source
          cd source
          git checkout "${{ inputs.source_ref }}"

      - name: System deps (Linux desktop)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.29.3
          cache: true

      - name: Build (Linux)
        shell: bash
        run: |
          set -euo pipefail
          bash source/tool/ci/build.sh --target linux --out "$GITHUB_WORKSPACE/artifacts" --project apps/okret_chat
          bash source/tool/ci/build.sh --target linux --out "$GITHUB_WORKSPACE/artifacts" --project apps/okret_admin

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-linux
          path: artifacts/*
          retention-days: 1
          if-no-files-found: error

  android:
    if: contains(inputs.platforms, 'android')
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH (deploy key)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}

      - name: Clone private source
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          git clone "git@github.com:${{ inputs.source_repo }}.git" source
          cd source
          git checkout "${{ inputs.source_ref }}"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.29.3
          cache: true

      - name: Build (Android APK)
        shell: bash
        run: |
          set -euo pipefail
          bash source/tool/ci/build.sh --target android --out "$GITHUB_WORKSPACE/artifacts" --project apps/okret_chat
          bash source/tool/ci/build.sh --target android --out "$GITHUB_WORKSPACE/artifacts" --project apps/okret_admin

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-android
          path: artifacts/*
          retention-days: 1
          if-no-files-found: error

  server:
    if: contains(inputs.platforms, 'server')
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH (deploy key)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}

      - name: Clone private source
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          git clone "git@github.com:${{ inputs.source_repo }}.git" source
          cd source
          git checkout "${{ inputs.source_ref }}"

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: 3.7.2

      - name: Build server (Okret Server, Linux)
        shell: bash
        run: |
          set -euo pipefail
          bash source/tool/ci/build.sh --target server --out "$GITHUB_WORKSPACE/artifacts"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-server
          path: artifacts/*
          retention-days: 1
          if-no-files-found: error

