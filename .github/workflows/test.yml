# Copy this file into your BUILD_REPO as: .github/workflows/test.yml
#
# Requirements:
# - BUILD_REPO is public and contains workflows only.
# - SOURCE_REPO is private and contains code + tool/ci/test.* scripts.
# - BUILD_REPO Actions secret: SOURCE_REPO_SSH_KEY (read-only deploy key for SOURCE_REPO).
#
# This workflow is workflow_dispatch-only and uploads short-lived test artifacts
# (logs, reports, screenshots/recordings if available). It never uploads source.

name: test

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: "owner/SOURCE_REPO (private)"
        required: true
        type: string
      source_ref:
        description: "Git ref in SOURCE_REPO (branch/tag/sha)"
        required: true
        type: string
      artifact_name:
        description: "Artifact name prefix"
        required: false
        default: "okret-chat-tests"
        type: string
      platforms:
        description: "Comma-separated: windows,linux,android,server"
        required: false
        default: "windows,linux,android,server"
        type: string

permissions:
  contents: read

jobs:
  server:
    if: contains(inputs.platforms, 'server')
    runs-on: ubuntu-latest
    steps:
      - name: Prepare artifact dir
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/artifacts"
          echo "placeholder" >"$GITHUB_WORKSPACE/artifacts/placeholder.txt"

      - name: Setup SSH (deploy key)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}

      - name: Clone private source
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          git clone "git@github.com:${{ inputs.source_repo }}.git" source
          cd source
          git checkout "${{ inputs.source_ref }}"

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: 3.7.2

      - name: Server unit tests
        id: server_tests
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          cd source/server/okret_server
          dart pub get >/dev/null
          dart test -r expanded | tee "$GITHUB_WORKSPACE/server_test.log"
          cp -f "$GITHUB_WORKSPACE/server_test.log" "$GITHUB_WORKSPACE/artifacts/server_test.log" || true

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-server
          path: |
            artifacts/*
          retention-days: 1
          if-no-files-found: warn

      - name: Fail if tests failed
        if: steps.server_tests.outcome == 'failure'
        shell: bash
        run: exit 1

  linux:
    if: contains(inputs.platforms, 'linux')
    runs-on: ubuntu-latest
    steps:
      - name: Prepare artifact dir
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/artifacts"
          echo "placeholder" >"$GITHUB_WORKSPACE/artifacts/placeholder.txt"

      - name: Setup SSH (deploy key)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}

      - name: Clone private source
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          git clone "git@github.com:${{ inputs.source_repo }}.git" source
          cd source
          git checkout "${{ inputs.source_ref }}"

      - name: System deps (Linux desktop + recording)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev xvfb ffmpeg

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.29.3
          cache: true

      - name: Test (Linux integration + report)
        id: linux_tests
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          bash source/tool/ci/test.sh \
            --target linux \
            --device linux \
            --out "$GITHUB_WORKSPACE/artifacts" \
            --project apps/okret_chat

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-linux
          path: artifacts/*
          retention-days: 1
          if-no-files-found: warn

      - name: Fail if tests failed
        if: steps.linux_tests.outcome == 'failure'
        shell: bash
        run: exit 1

  windows:
    if: contains(inputs.platforms, 'windows')
    runs-on: windows-latest
    steps:
      - name: Prepare artifact dir
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\\artifacts" | Out-Null
          "placeholder" | Out-File -FilePath "$env:GITHUB_WORKSPACE\\artifacts\\placeholder.txt" -Encoding utf8

      - name: Setup SSH (deploy key)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}

      - name: Clone private source
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          git clone "git@github.com:${{ inputs.source_repo }}.git" source
          cd source
          git checkout "${{ inputs.source_ref }}"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.29.3
          cache: true

      - name: Test (Windows integration + report)
        id: windows_tests
        continue-on-error: true
        shell: pwsh
        run: |
          ./source/tool/ci/test.ps1 -Target windows -OutDir "$env:GITHUB_WORKSPACE\\artifacts" -Project apps/okret_chat

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-windows
          path: artifacts/*
          retention-days: 1
          if-no-files-found: warn

      - name: Fail if tests failed
        if: steps.windows_tests.outcome == 'failure'
        shell: pwsh
        run: exit 1

  android:
    if: contains(inputs.platforms, 'android')
    runs-on: ubuntu-latest
    steps:
      - name: Prepare artifact dir
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/artifacts"
          echo "placeholder" >"$GITHUB_WORKSPACE/artifacts/placeholder.txt"

      - name: Setup SSH (deploy key)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}

      - name: Clone private source
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          git clone "git@github.com:${{ inputs.source_repo }}.git" source
          cd source
          git checkout "${{ inputs.source_ref }}"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.29.3
          cache: true

      - name: Enable KVM (best-effort)
        shell: bash
        run: |
          set -euo pipefail
          if [[ -e /dev/kvm ]]; then
            sudo chown "$(id -u)":"$(id -g)" /dev/kvm || true
            sudo chmod 666 /dev/kvm || true
            ls -la /dev/kvm || true
          else
            echo "/dev/kvm not present; emulator will run without hw accel."
          fi

      - name: Android integration test (emulator)
        id: android_tests
        continue-on-error: true
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          profile: pixel_5
          emulator-boot-timeout: 1200
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -no-snapshot-save -no-snapshot -metrics-collection
          disable-animations: true
          script: |
            bash source/tool/ci/test.sh \
              --target android \
              --device emulator-5554 \
              --base-url "http://10.0.2.2:8181" \
              --out "$GITHUB_WORKSPACE/artifacts" \
              --project apps/okret_chat

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-android
          path: artifacts/*
          retention-days: 1
          if-no-files-found: warn

      - name: Fail if tests failed
        if: steps.android_tests.outcome == 'failure'
        shell: bash
        run: exit 1
